# ç½‘é¡µæ˜¯å¦‚ä½•æ¸²æŸ“çš„

ä½œä¸ºä¸€ä¸ªå‰ç«¯å¼€å‘äººå‘˜ï¼Œæˆ‘ä»¬æœ‰å¿…è¦çŸ¥é“ä¸€ä¸ªç½‘é¡µæ˜¯å¦‚ä½•æ¸²æŸ“çš„ã€‚åœ¨æµè§ˆå™¨æ¸²æŸ“æ—¶ï¼Œå¸ƒå±€å’Œæ ·å¼ä»¥åŠæˆ‘ä»¬çš„`JS`è„šæœ¬éƒ½å¯¹æ¸²æŸ“çš„ä¼˜åŒ–é€ æˆå½±å“ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»åœ¨ä¹¦å†™å®ƒä»¬æ—¶å°±æœ‰æ„çš„æ¥é¿å…ä¸€äº›åæœŸæ€§èƒ½ä¸Šå¯èƒ½ä¼šå¸¦æ¥çš„é—®é¢˜ã€‚

> æœ¬æ–‡ä¸ä¼šæ·±å…¥æµè§ˆå™¨åº•å±‚æ¥è®²è¿°å…¶å¦‚ä½•æ¸²æŸ“ï¼Œåªä¼šä»‹ç»ä¸€äº›ä¸åŒæµè§ˆå™¨ä¸­é€šç”¨çš„æ¸²æŸ“åŸåˆ™ã€‚æ¯•ç«Ÿä¸åŒçš„æµè§ˆå™¨åº•å±‚å®ç°ä¸åŒ

## æµè§ˆå™¨æ˜¯å¦‚ä½•æ¸²æŸ“ä¸€ä¸ªé¡µé¢çš„

é¦–å…ˆæ€»ä½“æµè§ˆå™¨ä¸‹ä¸€ä¸ªæµè§ˆå™¨æ˜¯å¦‚ä½•æ¸²æŸ“ä¸€ä¸ªé¡µé¢çš„ï¼š

1. ä»æœåŠ¡å™¨è·å–åˆ°è¿”å›çš„`HTML`æ–‡ä»¶ï¼Œå¹¶è§£æç”Ÿæˆ`DOM`ï¼ˆæ–‡æ¡£å¯¹è±¡æ¨¡å‹`Document Object Model`ï¼‰ã€‚
2. åŠ è½½å¹¶è§£ææ ·å¼è¡¨ï¼ˆ`Styles`ï¼‰ï¼Œå¹¶è½¬åŒ–ä¸º`CSSOM`ï¼ˆ`CSS Object Model`ï¼‰
3. åŸºäº`DOM`å’Œ`CSSOM`ï¼Œç”Ÿæˆä¸€ä¸ªæ¸²æŸ“æ ‘ ğŸŒ²ï¼ˆ`Rendering Tree`ï¼‰ã€‚å®ƒå³ç­‰ä¼šè¦æ¸²æŸ“çš„å¯¹è±¡çš„é›†åˆã€‚ï¼ˆåŸºäº`Webkit`çš„æµè§ˆå™¨ç§°æ¸²æŸ“å¯¹è±¡ä¸º`render object`æˆ–`renderer`ï¼›åŸºäº`Gecko`çš„æµè§ˆå™¨ç§°ä¸º`frame`ï¼‰æ¸²æŸ“ ğŸŒ² ååº”äº†`DOM`çš„ç»“æ„ï¼ˆä¸åŒ…æ‹¬ä¸å¯è§çš„å…ƒç´ ï¼Œæ¯”å¦‚`head`å…ƒç´ æˆ–`display: none;`çš„å…ƒç´ ï¼‰ã€‚ä¸€ä¸ªæ–‡æœ¬å­—ç¬¦ä¸²ä¹Ÿè¡¨ç¤ºä¸€ä¸ªç‹¬ç«‹çš„èŠ‚ç‚¹ï¼ˆ`renderer`ï¼‰ã€‚æ¯ä¸€ä¸ªæ¸²æŸ“å¯¹è±¡éƒ½åŒ…å«äº†å…¶ç›¸å¯¹åº”çš„`DOM`å¯¹è±¡ï¼ˆæˆ–ä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹ï¼‰ä»¥åŠè®¡ç®—å¥½çš„æ ·å¼ã€‚ç®€è€Œè¨€ä¹‹ï¼Œæ¸²æŸ“ ğŸŒ² å°±æ˜¯ä¸€ç¾¤å¯è§†`DOM`èŠ‚ç‚¹çš„å‘ˆç°ã€‚
4. è®¡ç®—æ¸²æŸ“ ğŸŒ² ä¸­æ¯ä¸€ä¸ªï¼ˆå…ƒç´ ï¼‰èŠ‚ç‚¹çš„åæ ‡ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¹Ÿç§°ä¸ºå¸ƒå±€ï¼ˆ`Layout`ï¼‰ï¼ˆæˆ‘ä»¬å¸¸ç”¨çš„è¯´æ³•ä¹Ÿå°±æ˜¯é‡æ’`Reflow`ï¼‰ã€‚æµè§ˆå™¨ä½¿ç”¨ä¸€ç§æµï¼ˆ`flow`ï¼‰æ–¹æ³•ï¼Œåªéœ€è¦ä¸€æ¬¡å°±å¯ä»¥è®¡ç®—å‡ºæ‰€æœ‰èŠ‚ç‚¹çš„ä½ç½®ã€‚ï¼ˆè¡¨æ ¼è¿™ç§ç‰¹æ®Šçš„èŠ‚ç‚¹éœ€è¦å¤šæ¬¡è®¡ç®—ï¼‰
5. æœ€åå°†è¿™äº›èŠ‚ç‚¹å±•ç¤ºåœ¨æµè§ˆå™¨ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºç»˜åˆ¶ï¼ˆ`Paint`ï¼‰

å½“ç”¨æˆ·ä¸ä¸€ä¸ªé¡µé¢äº¤äº’æˆ–è„šæœ¬å¯¹é¡µé¢è¿›è¡Œä¿®æ”¹ï¼Œå¯¼è‡´é¡µé¢ç»“æ„å‘ç”Ÿæ”¹å˜æ—¶ï¼Œä¸Šè¿°çš„è¿‡ç¨‹å°±ä¼šé‡å¤çš„å‘ç”Ÿã€‚

## Repaint(é‡ç»˜)

å½“æ”¹å˜ä¸€ä¸ªèŠ‚ç‚¹çš„æ ·å¼ï¼Œä½†ä¸å½±å“å…¶èŠ‚ç‚¹çš„ä½ç½®æ—¶ï¼ˆè¿™äº›æ ·å¼æ¯”å¦‚`background-color/color/border-color/visibility etc.`ï¼‰ï¼Œæµè§ˆå™¨ä»…ä¼šç”¨æ–°çš„æ ·å¼é‡æ–°ç»˜åˆ¶èŠ‚ç‚¹ã€‚

## Reflow(é‡æ’)

å½“ä¸€ä¸ªæ”¹å˜å½±å“äº†æ–‡æ¡£çš„ç»“æ„ã€å†…å®¹æˆ–å…ƒç´ çš„ä½ç½®æ—¶ï¼Œä¸€æ¬¡é‡æ–°å¸ƒå±€ï¼ˆ`relayout/reflow`ï¼‰å°±ä¼šå‘ç”Ÿã€‚é€šå¸¸æ˜¯ç”±äºä»¥ä¸‹æ”¹å˜å¯¼è‡´çš„ï¼š

- `DOM`èŠ‚ç‚¹çš„æ“ä½œï¼ˆæ·»åŠ ã€åˆ é™¤ã€æ”¹å˜å…ƒç´ ï¼‰
- å†…å®¹å˜åŒ–ï¼ŒåŒ…æ‹¬è¡¨å•æ§ä»¶ä¸­çš„æ–‡æœ¬å˜åŒ–
- è®¡ç®—æˆ–æ”¹å˜`CSS`å±æ€§(æ¯”å¦‚è®¿é—®`document.body.offsetHeight`)
  - æ·»åŠ æˆ–ç§»é™¤ä¸€ä¸ªå±‚å æ ·å¼è¡¨ï¼ˆå‰ææ˜¯è¿™ä¸ªæ ·å¼è¡¨å¯¹æ–‡æ¡£é€ æˆäº†å½±å“ï¼‰
  - ä¸ºèŠ‚ç‚¹æ·»åŠ æˆ–åˆ é™¤`class`ï¼ˆè¿™ä¸ª`class`ä¼šå¯¹è¯¥å…ƒç´ çš„ä½ç½®é€ æˆå½±å“ï¼‰
- æµè§ˆå™¨è§†çª—çš„äº¤äº’ï¼ˆæ¯”å¦‚æ”¹å˜å…¶å°ºå¯¸æˆ–æ»šåŠ¨ï¼‰
- ä¼ªç±»å…ƒç´ çš„æ¿€æ´»ï¼ˆ`:hover`ï¼‰

## æµè§ˆå™¨æ˜¯å¦‚ä½•ä¼˜åŒ–æ¸²æŸ“çš„

æµè§ˆå™¨æ€»æ˜¯å°½æœ€å¤§åŠªåŠ›å»å°†é‡æ’å’Œé‡ç»˜é™åˆ¶åœ¨ä»…æ”¹å˜çš„å…ƒç´ ä¸Šã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªæ‹¥æœ‰ç»å¯¹/å›ºå®šï¼ˆ`absolute/fixed`ï¼‰å®šä½çš„å…ƒç´ çš„å°ºå¯¸æ”¹å˜ï¼Œä»…ä¼šå¯¹å…¶è‡ªèº«ä»¥åŠå…¶å­å…ƒç´ é€ æˆå½±å“ï¼Œè€ŒåŒæ ·çš„æ”¹å˜åœ¨ä¸€ä¸ªé™æ€å®šä½ï¼ˆ`statically`ï¼‰çš„å…ƒç´ ä¸Šä¼šé€ æˆæ•´ä¸ª**åç»­**å…ƒç´ çš„é‡æ’ã€‚

å¦ä¸€ä¸ªä¼˜åŒ–å°±æ˜¯å½“æˆ‘ä»¬è¿è¡Œä¸€è¿ä¸²çš„`JS`ä»£ç æ—¶ï¼Œæµè§ˆå™¨ä¼šç¼“å­˜åœ¨ä»£ç æ‰§è¡Œä¸­çš„å˜åŠ¨ï¼Œå¹¶åœ¨æ‰€æœ‰ä»£ç æ‰§è¡Œå®Œåï¼Œä¸€æ¬¡æ€§åº”ç”¨è¿™äº›å˜åŠ¨ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä»£ç åªä¼šé€ æˆä¸€æ¬¡é‡æ’å’Œé‡ç»˜ï¼š

```js
const body = document.body
body.style.padding = '10px'
body.style.color = 'red'
body.style.margin = '10px'
```

ä½†æ˜¯ï¼Œå¦‚ä¸Šé¢æåˆ°çš„ï¼Œè®¿é—®ä¸€ä¸ªèŠ‚ç‚¹çš„å±æ€§ä¼šå¯¼è‡´ä¸€æ¬¡å¼ºåˆ¶çš„é‡ç»˜ï¼ˆ`reflow`ï¼‰ã€‚

>è¿™å¾ˆå¥½ç†è§£ï¼Œå½“æˆ‘ä»¬è®¿é—®ä¸€ä¸ªå…ƒç´ çš„æ ·å¼å±æ€§æ—¶ï¼Œä¸ºäº†å¾—åˆ°æ”¹å±æ€§çš„ç²¾å‡†ä¿¡æ¯ï¼Œå¿…é¡»è¦é‡æ–°å¸ƒå±€æ¸²æŸ“æ¬¡ï¼Œä»¥å¾—åˆ°ç²¾å‡†çš„ä¿¡æ¯

å¦‚æœæˆ‘ä»¬æ·»åŠ ä¸‹é¢çš„ä»£ç ï¼Œé‚£ä¹ˆä¼šé€ æˆä¸¤æ¬¡é‡æ’ï¼š

```js
const body = document.body
body.style.padding = '10px'

// è¯»å–å…ƒç´ çš„æ ·å¼
body.style.padding

body.style.color = 'red'
body.style.margin = '10px'
```

æ‰€ä»¥ï¼Œå¦‚æœæœ‰è¯»å–å±æ€§çš„éœ€æ±‚ï¼Œåº”è¯¥ç»å†åœ¨ä¸€èµ·è¿›è¡Œæ‰§è¡Œï¼Œè¿™æ ·å¯ä»¥å¯¹æ¸²æŸ“çš„æ€§èƒ½è¿›è¡Œä¼˜åŒ–ã€‚

### æœ‰æ—¶ä½ éœ€è¦ä¸€æ¬¡å¼ºåˆ¶é‡æ’

å½“æˆ‘ä»¬åˆ¶ä½œä¸€ä¸ªåŠ¨ç”»æ—¶ï¼Œå‡å¦‚æˆ‘ä»¬éœ€è¦å¯¹`margin-left`åšä¸€ä¸ªåŠ¨ç”»ï¼Œåœ¨åŠ¨ç”»æœ€åˆï¼Œ`margin-left`çš„å€¼ä¸º`100px`ï¼Œåœ¨åŠ¨ç”»çš„æœ€ç»ˆï¼Œæˆ‘ä»¬éœ€è¦å°†`margin-left`çš„å€¼å˜ä¸º`50px`

æˆ‘ä»¬åº”ç”¨åŠ¨ç”»çš„è¿‡æ¸¡ç±»ä¸ºï¼š

```css
.has-transition {
   -webkit-transition: margin-left 1s ease-out;
      -moz-transition: margin-left 1s ease-out;
        -o-transition: margin-left 1s ease-out;
           transition: margin-left 1s ease-out;
}
```

é‚£ä¹ˆæ·»åŠ åŠ¨ç”»çš„ä»£ç ä¸ºï¼š

```js
const el = document.querySelector('.ball')

el.style.marginLeft = '100px'

// æ·»åŠ è¿‡æ¸¡æ ·å¼
el.addClass('has-transition')

// å˜æ›´å±æ€§å¼€å§‹åŠ¨ç”»ï¼ˆå®é™…ä¸ä¼šå¼€å§‹åŠ¨ç”»ï¼‰
el.style.marginLeft = '50px'

// åŠ¨ç”»ç»“æŸç§»é™¤è¿‡æ¸¡ç±»
el.addEventListener('transitioned', () => el.removeClass('has-transition'))
```

ç”±äºæˆ‘ä»¬åœ¨ä¹‹å‰çŸ¥é“ï¼Œæµè§ˆå™¨ä¼šå°†ä»£ç å¯¹äºå…ƒç´ çš„æ“ä½œæ•´åˆåˆ°æœ€ååº”ç”¨ï¼Œæ‰€ä»¥ä¸Šé¢ç›¸å½“äºç›´æ¥åº”ç”¨äº†`margin-left: 50px;`è€Œä¸ä¼šæœ‰åŠ¨ç”»æ•ˆæœã€‚æ‰€ä»¥æˆ‘ä»¬å¿…é¡»è¦æ±‚å…¶å¼ºåˆ¶é‡æ’æ¬¡æ¥è¾¾åˆ°åŠ¨ç”»æ•ˆæœï¼š

```js
const el = document.querySelector('.ball')

el.style.marginLeft = '100px'

// æ·»åŠ è¿‡æ¸¡æ ·å¼
el.addClass('has-transition')

// è·å–æµè§ˆå™¨å±æ€§ï¼Œå¼ºåˆ¶é‡æ’
document.body.offsetHeight

// å˜æ›´å±æ€§å¼€å§‹åŠ¨ç”»ï¼ˆå®é™…ä¸ä¼šå¼€å§‹åŠ¨ç”»ï¼‰
el.style.marginLeft = '50px'

// åŠ¨ç”»ç»“æŸç§»é™¤è¿‡æ¸¡ç±»
el.addEventListener('transitioned', () => el.removeClass('has-transition'))
```

è¿™æ ·åŠ¨ç”»å°±èƒ½å¦‚æœŸæ‰§è¡Œäº†

## ä¼˜åŒ–çš„å¯å®è·µå»ºè®®

ä¸‹é¢æœ‰å‡ æ¡æ¨èçš„ä¼˜åŒ–å»ºè®®ï¼š

- åˆ›å»ºæœ‰æ•ˆçš„`HTML`å…ƒç´ ä¸`CSS`æ ·å¼ï¼Œå¹¶ä¸”åˆ¶å®š`HTML`æ–‡æ¡£çš„ç¼–ç ã€‚å°†å±‚å æ ·å¼è¡¨æ”¾åœ¨`head`ä¸­ï¼Œå°†`JS`è„šæœ¬æ”¾åœ¨`body`å…ƒç´ çš„é—­æ ‡ç­¾ä¹‹å‰ã€‚
- ç®€åŒ–å’Œä¼˜åŒ–`CSS`é€‰æ‹©å™¨ï¼ˆå¤§å¤šæ•°ä½¿ç”¨é¢„å¤„ç†å™¨çš„å¼€å‘è€…å¿½è§†äº†è¿™ç‚¹ï¼‰ï¼Œä¿æŒé€‰æ‹©å™¨çš„å±‚çº§åœ¨ä¸€ä¸ªæœ€å°çš„èŒƒå›´ï¼ˆä¸€èˆ¬æ¥è¯´æœ€å¤§ä¸‰å±‚ï¼‰ï¼Œä¸‹é¢æ˜¯é€‰æ‹©å™¨çš„æŸ¥æ‰¾æ€§èƒ½æ’è¡Œï¼š
    1. è¯†åˆ«å™¨ï¼ˆ`Identificator`ï¼‰ï¼š`#id`
    2. ç±»ï¼ˆ`Class`ï¼‰ï¼š`.class`
    3. æ ‡ç­¾ï¼ˆ`Tag`ï¼‰ï¼š`div`
    4. å…„å¼Ÿé€‰æ‹©å™¨ï¼š`a + i`
    5. çˆ¶å­é€‰æ‹©å™¨ï¼š`ul > li`
    6. é€šç”¨é€‰æ‹©å™¨ï¼š`*`
    7. å±æ€§é€‰æ‹©å™¨ï¼š`input[type="text"]`
    8. ä¼ªç±»é€‰æ‹©å™¨å’Œä¼ªç±»å…ƒç´ ï¼š`a:hover`

æµè§ˆå™¨å¤„ç†é€‰æ‹©å™¨æ˜¯ä»å³åˆ°å·¦çš„ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¶Šé è¿‘å³è¾¹çš„é€‰æ‹©å™¨åº”è¯¥åœ¨æ€§èƒ½å¤„ç†ä¸Šæœ€å¿«çš„ä¸€ä¸ªâ€”â€”`#id`æˆ–`.class`

```css
div * { ... } // bad
.list li { ... } // bad
.list-item { ... } // good
#list .list-item { ... } good
```

- å°½é‡å‡å°‘å¯¹`DOM`çš„æ“ä½œã€‚ç¼“å­˜`DOM`çš„ä¿¡æ¯å¹¶å¤ç”¨å®ƒä»¬ã€‚å°½é‡åœ¨æ“ä½œ`DOM`æ—¶å°†å…¶è¿›è¡Œâ€œç¦»çº¿â€å¤„ç†ã€‚ï¼ˆæ‰€è°“ç¦»çº¿å°±æ˜¯å°†`DOM`ç‰‡æ®µä»æ–‡æ¡£ä¸­ç§»é™¤åè¿›è¡Œæ“ä½œï¼Œç„¶ååœ¨å°†å…¶æ’å…¥åˆ°æ–‡æ¡£ä¸­ï¼‰
- å¯¹æ‰§è¡ŒåŠ¨ç”»çš„å…ƒç´ ä½¿ç”¨`fixed/absolute`å¸ƒå±€
- é€šè¿‡æ·»åŠ `class`æ¥å¯¹å…ƒç´ çš„æ ·å¼è¿›è¡Œæ“ä½œ
- åœ¨æ»šåŠ¨æ—¶ç¦ç”¨å¤æ‚çš„`:hover`åŠ¨ç”»

Learn and sum up from [What Every Frontend Developer Should Know About Webpage Rendering](http://frontendbabel.info/articles/webpage-rendering-101/#practical-advice-on-optimization)